<script setup lang="ts">
import { computed, ref, onMounted, onBeforeUnmount, watch } from 'vue'
import { useRoute, useRouter } from '#app'
import { useApi } from '../../composables/useApi'
import { useAuth } from '../../composables/useAuth'

defineOptions({ name: 'AppHeader' })

const api = useApi()
const auth = useAuth()
const router = useRouter()
const route = useRoute()
const showAuthModal = ref(false)
const mobileMenuOpen = ref(false)
const isHero = computed(() => route.meta?.hero === true)
const open = ref(false)

function close() {
  open.value = false
}

watch(open, v => document.documentElement.classList.toggle('overflow-hidden', v))

const scrolled = ref(false)
const handleScroll = () => {
  scrolled.value = window.scrollY > 120
}

onMounted(() => window.addEventListener('scroll', handleScroll, { passive: true }))
onBeforeUnmount(() => window.removeEventListener('scroll', handleScroll))

/* dropdown hover: небольшая задержка на закрытие */
const dropdown = ref<Record<string, boolean>>({
  departures: false,
  destinations: false,
  triptypes: false,
  deals: false,
  events: false,
  info: false,
  user: false
})

let closeTimers: Record<string, number> = {}

function openDropdown(key: string) {
  clearTimeout(closeTimers[key])
  dropdown.value[key] = true
}

function closeDropdown(key: string) {
  clearTimeout(closeTimers[key])
  closeTimers[key] = window.setTimeout(() => dropdown.value[key] = false, 140)
}

/* подтянуть профиль для аватарки/имени */
onMounted(async () => {
  if (auth.accessToken.value && !auth.user.value) {
    try {
      const me = await api('/api/accounts/me/', { method: 'GET' })
      auth.user.value = me as any
    } catch {
      auth.clearSession()
    }
  }
})

/* logout (бэкенд ждёт refresh) */
const logout = async () => {
  try {
    if (auth.refreshToken.value) {
      await api('/api/accounts/logout/', { method: 'POST', body: { refresh: auth.refreshToken.value } })
    }
  } catch {}
  auth.clearSession()
  router.push('/')
}

/* инициалы для плейсхолдера аватара */
const initials = computed(() => {
  const full = (auth.user.value?.full_name || auth.user.value?.name || '').trim()
  if (!full) return 'U'
  const parts = full.split(/\s+/).filter(Boolean)
  return ((parts[0]?.[0] || '') + (parts[1]?.[0] || '')).toUpperCase()
})
</script>

<template>
  <header
    class="fixed inset-x-0 z-50 transition-all duration-300"
    :class="{
      'bg-white text-black h-12 pt-1 border border-b-gray-100  top-0': scrolled,
      'bg-transparent text-white h-14 top-2' : !scrolled && isHero,
      'bg-white text-black h-12 pt-1  top-0': !isHero
    }"
  >
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-full items-center justify-between gap-6">
        <!-- LOGO -->
        <NuxtLink to="/" class="inline-flex items-center text-xl font-extrabold tracking-tight group">
          <span class="transition-colors group-hover:text-white"
                :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">Group</span>
          <span class="mx-1 rounded-full px-2 py-0.5 transition-colors"
                :class="(!scrolled && isHero)
                  ? 'bg-white text-black group-hover:bg-indigo-100'
                  : 'bg-lime-500 text-white group-hover:bg-lime-400'">Tour</span>
          <span class="transition-colors group-hover:text-white"
                :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">Dates</span>
        </NuxtLink>

        <!-- NAV — скрыто на мобильных -->
        <nav class="hidden lg:flex flex-1 items-center justify-center gap-6">
          <div class="relative"
               @mouseenter="openDropdown('departures')" @mouseleave="closeDropdown('departures')">
            <button class="nav-link flex items-center gap-1 hover:text-white"
                    :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">
              Departures
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
            </button>
            <transition name="dd-fade">
              <div v-show="dropdown.departures" class="mega mega-3 absolute left-1/2 -translate-x-1/2 top-full mt-2">
                <div class="mega-panel grid grid-cols-3 gap-6">
                  <div><h4 class="mega-title">Months</h4><ul class="mega-list">
                    <li v-for="month in ['october','november','december','january','february','march','april','may','june','july','august','september']" :key="month">
                      <NuxtLink class="dd-item" :to="`/months/${month}`">{{ month.charAt(0).toUpperCase() + month.slice(1) }}</NuxtLink>
                    </li>
                  </ul></div>
                  <div><h4 class="mega-title">Recommended</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/deals/last-minute">Last Minute Deals</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/holidays">Public Holidays</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/autumn">Autumn Escapes</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/half-term">Half Term Trips</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/thanksgiving">Thanksgiving Departures</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/christmas-new-year">Christmas & New Years Eve Trips</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/spring">Spring 2026</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/summer">Summer 2026</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">All confirmed departures</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/departures/">All departures</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/departures/y2026">2026 departures</NuxtLink></li>
                  </ul></div>
                </div>
              </div>
            </transition>
          </div>

          <div class="relative"
               @mouseenter="openDropdown('destinations')" @mouseleave="closeDropdown('destinations')">
            <button class="nav-link flex items-center gap-1 hover:text-white"
                    :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">
              Destinations
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
            </button>
            <transition name="dd-fade">
              <div v-show="dropdown.destinations" class="mega mega-6 absolute left-1/2 -translate-x-1/2 top-full mt-2">
                <div class="mega-panel grid grid-cols-6 gap-6">
                  <div><h4 class="mega-title">Europe</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/destinations/europe/italy">Italy</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/europe/sweden">Sweden</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/europe/romania">Romania</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/europe/iceland">Iceland</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/europe/spain">Spain</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/europe">All trips to Europe</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">Asia</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/destinations/asia/indonesia">Indonesia</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/asia/vietnam">Vietnam</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/asia/thailand">Thailand</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/asia/kyrgyzstan">Kyrgyzstan</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/asia/sri-lanka">Sri Lanka</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/asia/japan">Japan</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/asia/maldives">Maldives</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/asia">All trips to Asia</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">Middle East</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/destinations/middle-east/jordan">Jordan</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/middle-east/oman">Oman</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/middle-east/turkey">Turkey</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/middle-east">All trips to the Middle East</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">The Americas</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/destinations/americas/usa">USA</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/americas/mexico">Mexico</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/americas/peru">Peru</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/americas/colombia">Colombia</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/americas">All trips to America</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/americas/south-america">All trips to South America</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">Africa</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/destinations/africa/morocco">Morocco</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/africa/egypt">Egypt</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/africa/tanzania">Tanzania</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/destinations/africa">All trips to Africa</NuxtLink></li>
                  </ul></div>
                  <div>
                    <h4 class="mega-title">Oceania</h4>
                    <ul class="mega-list">
                      <li><NuxtLink class="dd-item" to="/destinations/oceania">All trips to Oceania</NuxtLink></li>
                    </ul>
                    <h4 class="mega-title mt-3">All destinations</h4>
                    <ul class="mega-list">
                      <li><NuxtLink class="dd-item" to="/destinations">All destinations</NuxtLink></li>
                    </ul>
                  </div>
                </div>
              </div>
            </transition>
          </div>

          <div class="relative"
               @mouseenter="openDropdown('triptypes')" @mouseleave="closeDropdown('triptypes')">
            <button class="nav-link flex items-center gap-1 hover:text-white"
                    :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">
              Trip Types
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
            </button>
            <transition name="dd-fade">
              <div v-show="dropdown.triptypes" class="mega mega-3 absolute left-1/2 -translate-x-1/2 top-full mt-2">
                <div class="mega-panel grid grid-cols-3 gap-6">
                  <div><h4 class="mega-title">Trip Types</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/types/360">360°</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/beach-life">Beach Life</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/city-escape">City Escape</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/road-trips">Road Trips</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/safari">Safari</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/expedition">Expedition</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/express">Express</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/multi-country">Multi Country</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/northern-lights">Northern Lights</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/events">Special events</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/collection">Collection</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/art-culture">Art & culture</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types/food-wine">Food & Wine</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/types">All trip types</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">Active</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/trip-types/trekking">Trekking & Hiking</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/trip-types/ski_holiday">Ski & Snowboard</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/trip-types/all_active">All Active trips</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">Trending</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/trending/new-itineraries">New itineraries</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/trending/top-sellers">Our top sellers</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/trending/bucket-list">Bucket list</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/quiz">Trip Finder Quiz</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/trending/first-trip">Your first WeRoad</NuxtLink></li>
                  </ul></div>
                </div>
              </div>
            </transition>
          </div>

          <div class="relative"
               @mouseenter="openDropdown('deals')" @mouseleave="closeDropdown('deals')">
            <button class="nav-link flex items-center gap-1 hover:text-white"
                    :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">
              Deals
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
            </button>
            <transition name="dd-fade">
              <div v-show="dropdown.deals" class="mega mega-2 absolute left-1/2 -translate-x-1/2 top-full mt-2">
                <div class="mega-panel grid grid-cols-2 gap-6">
                  <div><h4 class="mega-title">Travel Deals</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/deals/last-minute">Last Minute Deals</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/deals/private-room">Private Room included</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/deals/refer">Refer a friend</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">Other Deals</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/deals/benefits">Benefits for WeRoaders</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/deals/student">Student Discounts</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/deals/company">Company & Employee Discounts</NuxtLink></li>
                  </ul></div>
                </div>
              </div>
            </transition>
          </div>

          <div class="relative"
               @mouseenter="openDropdown('events')" @mouseleave="closeDropdown('events')">
            <button class="nav-link flex items-center gap-1 hover:text-white"
                    :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">
              Events & Community
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
            </button>
            <transition name="dd-fade">
              <div v-show="dropdown.events" class="mega mega-2 absolute left-1/2 -translate-x-1/2 top-full mt-2">
                <div class="mega-panel grid grid-cols-2 gap-6">
                  <div><h4 class="mega-title">WeRoad Events</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/events/wemeet">Join a WeMeet – download the app!</NuxtLink></li>
                  </ul></div>
                  <div><h4 class="mega-title">Community</h4><ul class="mega-list">
                    <li><NuxtLink class="dd-item" to="/community/facebook">Join our Facebook group!</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/community/coordinators">Our Travel Coordinators</NuxtLink></li>
                    <li><NuxtLink class="dd-item" to="/community/instagram-live">Instagram Live</NuxtLink></li>
                  </ul></div>
                </div>
              </div>
            </transition>
          </div>

          <div class="relative"
               @mouseenter="openDropdown('info')" @mouseleave="closeDropdown('info')">
            <button class="nav-link flex items-center gap-1 hover:text-white"
                    :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">
              Info
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
            </button>
            <transition name="dd-fade">
              <div v-show="dropdown.info" class="mega mega-1 absolute left-1/2 -translate-x-1/2 top-full mt-2">
                <div class="mega-panel grid grid-cols-1 gap-1 w-[260px]">
                  <NuxtLink class="dd-item" to="/info/how-it-works">How it works</NuxtLink>
                  <NuxtLink class="dd-item" to="/info/about-us">About us</NuxtLink>
                  <NuxtLink class="dd-item" to="/info/cancellation">Cancellation policy</NuxtLink>
                  <NuxtLink class="dd-item" to="/info/shared-room">Shared room, how does it work?</NuxtLink>
                  <NuxtLink class="dd-item" to="/info/flight-support">Flight support</NuxtLink>
                  <NuxtLink class="dd-item" to="/info/faq">FAQ</NuxtLink>
                </div>
              </div>
            </transition>
          </div>
        </nav>

        <!-- Мобильная бургер-кнопка -->
        <div class="flex lg:hidden items-center gap-3 relative z-50">
          <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white">
            <svg v-if="!mobileMenuOpen" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg v-else class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="hidden lg:flex items-center gap-3">
          <div class="relative"
               @mouseenter="openDropdown('user')" @mouseleave="closeDropdown('user')">
            <button class="flex items-center gap-2 hover:text-white"
                    :class="(!scrolled && isHero) ? 'text-white' : 'text-black'">
              <template v-if="auth.user.value">
                <img v-if="auth.user.value?.avatar"
                     :src="auth.user.value.avatar" alt="avatar"
                     class="h-8 w-8 rounded-full object-cover ring-2 ring-white/50" />
                <div v-else class="h-8 w-8 rounded-full bg-indigo-600 text-white grid place-items-center text-xs font-semibold">
                  {{ initials }}
                </div>
              </template>
              <div v-else class="h-8 w-8 rounded-full bg-gray-200 text-gray-700 grid place-items-center">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
              </svg>
            </button>
            <transition name="dd-fade">
              <div v-show="dropdown.user" class="absolute right-0 top-full mt-2 w-56 rounded-xl border border-base-300 bg-base-100 p-2 shadow-xl">
                <template v-if="auth.user.value">
                  <NuxtLink class="dd-item" to="/dashboard/">My account</NuxtLink>
                  <NuxtLink class="dd-item" to="/account/bookings">My bookings</NuxtLink>
                  <button class="dd-item w-full text-left" @click="logout">Log out</button>
                </template>
                <template v-else>
                  <NuxtLink to="/accounts/login" class="dd-item">Sign in</NuxtLink>
                  <NuxtLink to="/accounts/register" class="dd-item">Sign up</NuxtLink>
                </template>
              </div>
            </transition>
          </div>
        </div>
      </div>
    </div>

    <!-- Мобильное меню -->
    <transition name="slide-down">
      <div
        v-show="mobileMenuOpen"
        class="fixed inset-0 z-40 bg-white lg:hidden"
        @click.self="mobileMenuOpen = false"
      >
        <div class="flex flex-col h-full overflow-y-auto p-6"
             :class="{ 'pt-20': !scrolled, 'pt-6': scrolled }">


          <div class="space-y-5">
            <!-- Departures -->
            <div>
              <button @click="openDropdown('departures')" class="flex justify-between items-center w-full text-left py-2 font-medium text-black">
                Departures
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div v-show="dropdown.departures" class="pl-4 space-y-1.5 mt-2">
                <NuxtLink
                  v-for="to in ['/months/october','/months/november','/months/december','/months/january','/months/february','/months/march','/months/april','/months/may','/months/june','/months/july','/months/august','/months/september','/deals/last-minute','/departures/holidays','/themes/autumn-escapes','/themes/half-term','/departures/thanksgiving','/departures/christmas-new-year','/spring-2026','/summer-2026','/departures/all','/departures/2026']"
                  :key="to"
                  class="block py-1 text-black"
                  :to="to"
                  @click.stop="mobileMenuOpen = false; dropdown.departures = false;"
                >
                  {{ to.split('/').pop()?.replace(/-/g, ' ') }}
                </NuxtLink>
              </div>
            </div>

            <!-- Destinations -->
            <div>
              <button @click="openDropdown('destinations')" class="flex justify-between items-center w-full text-left py-2 font-medium text-black">
                Destinations
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div v-show="dropdown.destinations" class="pl-4 space-y-1.5 mt-2">
                <NuxtLink
                  v-for="to in [
                    '/destinations/europe/italy',
                    '/destinations/europe/sweden',
                    '/destinations/europe/romania',
                    '/destinations/europe/iceland',
                    '/destinations/europe/spain',
                    '/destinations/europe',
                    '/destinations/asia/indonesia',
                    '/destinations/asia/vietnam',
                    '/destinations/asia/thailand',
                    '/destinations/asia/kyrgyzstan',
                    '/destinations/asia/sri-lanka',
                    '/destinations/asia/japan',
                    '/destinations/asia/maldives',
                    '/destinations/asia',
                    '/destinations/middle-east/jordan',
                    '/destinations/middle-east/oman',
                    '/destinations/middle-east/turkey',
                    '/destinations/middle-east',
                    '/destinations/americas/usa',
                    '/destinations/americas/mexico',
                    '/destinations/americas/peru',
                    '/destinations/americas/colombia',
                    '/destinations/americas',
                    '/destinations/americas/south-america',
                    '/destinations/africa/morocco',
                    '/destinations/africa/egypt',
                    '/destinations/africa/tanzania',
                    '/destinations/africa',
                    '/destinations/oceania',
                    '/destinations'
                  ]"
                  :key="to"
                  class="block py-1 text-black"
                  :to="to"
                  @click.stop="mobileMenuOpen = false; dropdown.destinations = false;"
                >
                  {{ to.split('/').pop()?.replace(/-/g, ' ') }}
                </NuxtLink>
              </div>
            </div>

            <!-- Trip Types -->
            <div>
              <button @click="openDropdown('triptypes')" class="flex justify-between items-center w-full text-left py-2 font-medium text-black">
                Trip Types
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div v-show="dropdown.triptypes" class="pl-4 space-y-1.5 mt-2">
                <NuxtLink
                  v-for="to in [
                    '/types/360',
                    '/types/beach-life',
                    '/types/city-escape',
                    '/types/road-trips',
                    '/types/safari',
                    '/types/expedition',
                    '/types/express',
                    '/types/multi-country',
                    '/types/northern-lights',
                    '/types/events',
                    '/types/collection',
                    '/types/art-culture',
                    '/types/food-wine',
                    '/types',
                    '/active/trekking',
                    '/active/ski',
                    '/active',
                    '/trending/new-itineraries',
                    '/trending/top-sellers',
                    '/trending/bucket-list',
                    '/quiz',
                    '/trending/first-trip'
                  ]"
                  :key="to"
                  class="block py-1 text-black"
                  :to="to"
                  @click.stop="mobileMenuOpen = false; dropdown.triptypes = false;"
                >
                  {{ to.split('/').pop()?.replace(/-/g, ' ') }}
                </NuxtLink>
              </div>
            </div>

            <!-- Deals -->
            <div>
              <button @click="openDropdown('deals')" class="flex justify-between items-center w-full text-left py-2 font-medium text-black">
                Deals
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div v-show="dropdown.deals" class="pl-4 space-y-1.5 mt-2">
                <NuxtLink
                  v-for="to in [
                    '/deals/last-minute',
                    '/deals/private-room',
                    '/deals/refer',
                    '/deals/benefits',
                    '/deals/student',
                    '/deals/company'
                  ]"
                  :key="to"
                  class="block py-1 text-black"
                  :to="to"
                  @click.stop="mobileMenuOpen = false; dropdown.deals = false;"
                >
                  {{ to.split('/').pop()?.replace(/-/g, ' ') }}
                </NuxtLink>
              </div>
            </div>

            <!-- Events & Community -->
            <div>
              <button @click="openDropdown('events')" class="flex justify-between items-center w-full text-left py-2 font-medium text-black">
                Events & Community
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div v-show="dropdown.events" class="pl-4 space-y-1.5 mt-2">
                <NuxtLink
                  v-for="to in [
                    '/events/wemeet',
                    '/community/facebook',
                    '/community/coordinators',
                    '/community/instagram-live'
                  ]"
                  :key="to"
                  class="block py-1 text-black"
                  :to="to"
                  @click.stop="mobileMenuOpen = false; dropdown.events = false;"
                >
                  {{ to.split('/').pop()?.replace(/-/g, ' ') }}
                </NuxtLink>
              </div>
            </div>

            <!-- Info -->
            <div>
              <button @click="openDropdown('info')" class="flex justify-between items-center w-full text-left py-2 font-medium text-black">
                Info
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div v-show="dropdown.info" class="pl-4 space-y-1.5 mt-2">
                <NuxtLink
                  v-for="to in [
                    '/info/how-it-works',
                    '/info/about-us',
                    '/info/cancellation',
                    '/info/shared-room',
                    '/info/flight-support',
                    '/info/faq'
                  ]"
                  :key="to"
                  class="block py-1 text-black"
                  :to="to"
                  @click.stop="mobileMenuOpen = false; dropdown.info = false;"
                >
                  {{ to.split('/').pop()?.replace(/-/g, ' ') }}
                </NuxtLink>
              </div>
            </div>

            <!-- Auth -->
            <div class="pt-4 border-t border-gray-200">
              <template v-if="auth.user.value">
                <NuxtLink class="block py-2 text-black" to="/account" @click.stop="mobileMenuOpen = false">My account</NuxtLink>
                <NuxtLink class="block py-2 text-black" to="/account/bookings" @click.stop="mobileMenuOpen = false">My bookings</NuxtLink>
                <button @click.stop="() => { logout(); mobileMenuOpen = false; }" class="block w-full text-left py-2 text-black">Log out</button>
              </template>
              <template v-else>
                <button @click.stop="() => { showAuthModal = true; mobileMenuOpen = false; }" class="block w-full text-left py-2 text-black">Sign in</button>
                <NuxtLink to="/register" class="block py-2 text-black" @click.stop="mobileMenuOpen = false">Sign up</NuxtLink>
              </template>
            </div>
          </div>
        </div>
      </div>
    </transition>

  </header>
</template>

<style scoped>
/* Подчёркивание чуть ниже текста */
.nav-link {
  @apply relative inline-flex items-center text-sm font-medium leading-none text-inherit;
}
.nav-link::after {
  content: '';
  @apply absolute left-0 w-0 h-0.5 bg-current transition-all duration-200 ease-in-out;
  bottom: -4px;
}
.nav-link:hover::after {
  @apply w-full;
}

/* оболочка мега-меню */
.mega {
  @apply absolute left-1/2 -translate-x-1/2 top-full z-50;
  min-width: 260px;
}
.mega-1 .mega-panel { width: 260px; }
.mega-2 .mega-panel { width: 680px; }
.mega-3 .mega-panel { width: 900px; }
.mega-6 .mega-panel { width: 1040px; }

.mega-panel {
  @apply rounded-xl border border-gray-200 bg-white shadow-lg p-5;
}

.mega-title {
  @apply text-xs font-semibold text-gray-800 mb-2 uppercase tracking-wider;
}
.mega-list {
  @apply space-y-1;
}
.dd-item {
  @apply block rounded px-2.5 py-1.5 text-sm text-gray-700 hover:bg-gray-50;
}

.dd-fade-enter-active, .dd-fade-leave-active {
  transition: opacity 0.15s ease, transform 0.15s ease;
}
.dd-fade-enter-from, .dd-fade-leave-to {
  opacity: 0;
  transform: translateY(4px);
}

.slide-down-enter-active, .slide-down-leave-active {
  transition: transform 0.3s ease;
}
.slide-down-enter-from { transform: translateY(-100%); }
.slide-down-leave-to { transform: translateY(-100%); }
</style>
